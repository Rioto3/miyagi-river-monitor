name: å®®åŸçœŒæ²³å·æƒ…å ±ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚(æ—¥æœ¬æ™‚é–“)ã«å®Ÿè¡Œ = UTC 0:00
    - cron: '0 0 * * *'

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
        with:
          ref: release # releaseãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨
          fetch-depth: 0 # å±¥æ­´ã‚’å…¨ã¦å–å¾—
      
      - name: mainãƒ–ãƒ©ãƒ³ãƒã®å†…å®¹ã‚’å–å¾—
        run: |
          git fetch origin main
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’mainã‹ã‚‰releaseã«ã‚³ãƒ”ãƒ¼
          git checkout origin/main -- scraper.py requirements.txt
      
      - name: Python 3.9ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®å®Ÿè¡Œ
        run: python scraper.py
      
      - name: jqã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
        run: |
          if ! command -v jq &> /dev/null; then
            echo "jqã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™"
            sudo apt-get update
            sudo apt-get install -y jq
          fi
      
      - name: çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦å¤‰æ›´ã‚’ç¢ºèª
        id: check_changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # æ–°ã—ã„è¨˜äº‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add new_river_articles_*.csv miyagi_river_metadata.json
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚"
            git commit -m "æ›´æ–°: å®®åŸçœŒæ²³å·æƒ…å ± æ–°ã—ã„è¨˜äº‹ $(date +'%Y-%m-%d')"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # æœ€æ–°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«åã‚’å‡ºåŠ›
            latest_csv=$(ls -t new_river_articles_*.csv | head -n 1)
            echo "latest_csv=$latest_csv" >> $GITHUB_OUTPUT
          fi
      
      - name: å¤‰æ›´ã‚’releaseãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GHUB_TOKEN }}
          branch: release
      
      - name: é€šçŸ¥ã‚’é€ä¿¡
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # æœ€æ–°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
          latest_csv="${{ steps.check_changes.outputs.latest_csv }}"
          echo "å‡¦ç†ã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«: $latest_csv"
          
          # å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®å¤‰æ•°ã‚’åˆæœŸåŒ–
          all_messages=""
          
          # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦2è¡Œç›®ã‹ã‚‰å‡¦ç†ã™ã‚‹
          tail -n +2 "$latest_csv" | while IFS= read -r row; do
            # CSVã®è¡Œã‚’åˆ†è§£
            date=$(echo "$row" | cut -d',' -f1 | tr -d '\r\n')
            title=$(echo "$row" | cut -d',' -f2 | tr -d '\r\n')
            url=$(echo "$row" | cut -d',' -f3 | tr -d '\r\n')
            
            # ç©ºè¡Œã¾ãŸã¯ä¸å®Œå…¨ãªè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            if [ -z "$date" ] || [ -z "$title" ] || [ -z "$url" ]; then
              continue
            fi
            
            # å€‹åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            message="ğŸŒŠ å®®åŸçœŒæ²³å·æƒ…å ±ãƒ‹ãƒ¥ãƒ¼ã‚¹é€Ÿå ± ğŸš¨\n\nğŸ“… æ—¥ä»˜: ${date}\nğŸ“° ã‚¿ã‚¤ãƒˆãƒ«: ${title}\nğŸ”— ãƒªãƒ³ã‚¯: ${url}"
            
            # å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ ï¼ˆé–“ã«åŒºåˆ‡ã‚Šç·šã‚’å…¥ã‚Œã‚‹ï¼‰
            if [ -n "$all_messages" ]; then
              all_messages="${all_messages}\n\n-------------------\n\n${message}"
            else
              all_messages="${message}"
            fi
            
            # å€‹åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            curl -L -X POST \
              -H "Content-Type: application/json" \
              -d "{
                \"message\": \"$message\",
                \"x-api-key\": \"${{ secrets.MAKANA_LINE_API_KEY }}\"
              }" \
              "${{ secrets.MAKANA_CALL_URL }}"
            
            # é€šçŸ¥é–“ã®é…å»¶ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            sleep 2
            
          done